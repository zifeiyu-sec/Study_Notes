### **ä¸€ã€ååºåˆ—åŒ–æ¼æ´åŸºç¡€**

1. **åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ˜¯ä»€ä¹ˆï¼Ÿ**

   - **åºåˆ—åŒ–**ï¼šå°†Javaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµï¼ˆå¦‚ä¿å­˜åˆ°æ–‡ä»¶æˆ–ç½‘ç»œä¼ è¾“ï¼‰ 
   - **ååºåˆ—åŒ–**ï¼šå°†å­—èŠ‚æµè¿˜åŸä¸ºJavaå¯¹è±¡
   - **æ¼æ´æœ¬è´¨**ï¼šæ”»å‡»è€…æ„é€ æ¶æ„å­—èŠ‚æµï¼Œè§¦å‘ååºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„å±é™©æ“ä½œï¼ˆå¦‚å‘½ä»¤æ‰§è¡Œï¼‰

2. **ä¸ºä½•ä¼šäº§ç”Ÿæ¼æ´ï¼Ÿ**

   å½“ç¨‹åºå¯¹**ä¸å¯ä¿¡æ•°æ®**ï¼ˆå¦‚ç½‘ç»œä¼ è¾“ã€æ–‡ä»¶è¯»å–ï¼‰ç›´æ¥è°ƒç”¨`ObjectInputStream.readObject()`æ—¶ï¼Œè‹¥è¯¥æ•°æ®åŒ…å«ç²¾å¿ƒè®¾è®¡çš„æ¶æ„å¯¹è±¡é“¾ï¼Œä¼šè§¦å‘é¢„æœŸå¤–çš„ä»£ç æ‰§è¡Œã€‚

------

### **äºŒã€åˆ©ç”¨é“¾ï¼ˆGadget Chainï¼‰æ ¸å¿ƒé€»è¾‘**

#### ğŸ”‘ **1. åˆ©ç”¨é“¾ä¸‰è¦ç´ **

| ç»„ä»¶       | ä½œç”¨                                           | ç¤ºä¾‹ç±»/æ–¹æ³•                                                  |
| ---------- | ---------------------------------------------- | ------------------------------------------------------------ |
| **å…¥å£ç‚¹** | ååºåˆ—åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨çš„èµ·ç‚¹æ–¹æ³•                   | `HashMap.readObject()`, `BadAttributeValueExpException.readObject()` |
| **ä¼ é€’é“¾** | é€šè¿‡æ–¹æ³•è°ƒç”¨ã€å±æ€§è®¿é—®è¿æ¥å…¥å£å’Œå‡ºå£çš„ä¸­é—´ç¯èŠ‚ | `Map.put()`, `Transformer.transform()`, `equals()`           |
| **å‡ºå£ç‚¹** | æœ€ç»ˆæ‰§è¡Œå±é™©æ“ä½œçš„æ–¹æ³•ï¼ˆå¦‚å‘½ä»¤æ‰§è¡Œã€DNSè¯·æ±‚ï¼‰  | `Runtime.exec()`, `URLStreamHandler.hashCode()`              |

#### ğŸŒ° **2. å½¢è±¡æ¯”å–»**

> æŠŠåˆ©ç”¨é“¾çœ‹ä½œ**å¤šç±³è¯ºéª¨ç‰Œ**ï¼š
>
> - å…¥å£ç‚¹æ˜¯ç¬¬ä¸€å¼ ç‰Œï¼ˆ`readObject`è¢«æ¨å€’ï¼‰
> - ä¼ é€’é“¾æ˜¯ä¸­é—´è¿é”ååº”ï¼ˆç‰Œä¸ç‰Œä¹‹é—´çš„ç¢°æ’ï¼‰
> - å‡ºå£ç‚¹æ˜¯æœ€åä¸€å¼ ç‰Œï¼ˆå‘½ä»¤æ‰§è¡Œå€’åœ°ï¼‰

#### âš ï¸ **3. å…³é”®ç‰¹æ€§**

- **åŠ¨æ€åå°„è°ƒç”¨**ï¼šé€šè¿‡åå°„æ‰§è¡Œä»»æ„ç±»çš„æ–¹æ³•ï¼ˆå¦‚`InvokerTransformer.transform()`è°ƒç”¨`Runtime.exec()`ï¼‰
- **å¯¹è±¡åµŒå¥—æ§åˆ¶**ï¼šæ¶æ„å¯¹è±¡éœ€æ»¡è¶³å­—æ®µçº¦æŸï¼ˆå¦‚ç‰¹å®šç±»å±æ€§å€¼éœ€æ»¡è¶³æ¡ä»¶åˆ†æ”¯ï¼‰
- **å»¶è¿Ÿè§¦å‘**ï¼šåˆ©ç”¨åå°„ä¿®æ”¹å¯¹è±¡çŠ¶æ€ï¼Œé¿å…åºåˆ—åŒ–æ—¶ç«‹å³æ‰§è¡Œï¼ˆå¦‚URLDNSé“¾ä¿®æ”¹`url.hashCode=-1`ï¼‰

------

### **ä¸‰ã€ç»å…¸åˆ©ç”¨é“¾æ¡ˆä¾‹è§£æ**

#### ğŸ¯ **1. URLDNSé“¾ï¼ˆæ— å®³æ¢æµ‹ï¼‰**

- **ç”¨é€”**ï¼šæ¢æµ‹ç›®æ ‡æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼ˆä»…è§¦å‘DNSè¯·æ±‚ï¼Œä¸æ‰§è¡Œå‘½ä»¤ï¼‰

- **è°ƒç”¨é“¾**ï¼š

  ```mermaid
  graph LR
    A[HashMap.readObject] --> B[HashMap.putVal]
    B --> C[HashMap.hash]
    C --> D[URL.hashCode]
    D --> E[URLStreamHandler.hashCode]
    E --> F[å‘èµ·DNSè¯·æ±‚]
  ```

- **ç»•è¿‡æŠ€å·§**ï¼š

  ç”¨åå°„ä¸´æ—¶ä¿®æ”¹`url.hashCode=1234`â†’ æ‰§è¡Œ`map.put(url)`â†’ å†æ”¹å›`hashCode=-1`ï¼Œé¿å…æå‰è§¦å‘ã€‚

#### ğŸ’¥ **2. CommonsCollections1é“¾ï¼ˆå‘½ä»¤æ‰§è¡Œï¼‰**

- **æ¼æ´ç±»**ï¼š`InvokerTransformer`ï¼ˆé€šè¿‡åå°„æ‰§è¡Œä»»æ„æ–¹æ³•ï¼‰

- **æ ¸å¿ƒè°ƒç”¨é“¾**ï¼š

  ```
  BadAttributeValueExpException.readObject()
    â†’ TiedMapEntry.toString()
    â†’ LazyMap.get()
    â†’ ChainedTransformer.transform()  // ä¸²è”å¤šä¸ªTransformer
    â†’ InvokerTransformer.transform()   // åå°„è°ƒç”¨Runtime.exec("calc")
  ```

- **ä¾èµ–æ¡ä»¶**ï¼š

  - Apache Commons Collections â‰¤ 3.2.1
  - JDK â‰¤ 8u71ï¼ˆåç»­ç‰ˆæœ¬ä¿®å¤äº†`AnnotationInvocationHandler`çš„åˆ©ç”¨ï¼‰

#### ğŸ›¡ï¸ **3. JDK 8u71åçš„ç»•è¿‡ï¼ˆCC6é“¾ï¼‰**

- **ä¿®å¤ç»•è¿‡**ï¼šä¸å†ä¾èµ–`AnnotationInvocationHandler`ï¼Œæ”¹ç”¨`TiedMapEntry`ä½œä¸ºå…¥å£

- **æ–°è°ƒç”¨é“¾**ï¼š

  ```
  HashMap.readObject() 
    â†’ TiedMapEntry.hashCode() 
    â†’ TiedMapEntry.getValue() 
    â†’ LazyMap.get()  // è§¦å‘åç»­Transformerè°ƒç”¨é“¾
  ```

------

### **å››ã€æ¼æ´é˜²å¾¡æ–¹æ¡ˆ**

#### ğŸ› ï¸ **1. ä»£ç å±‚é˜²æŠ¤**

- **è¾“å…¥è¿‡æ»¤**ï¼šç¦ç”¨`ObjectInputStream`ï¼Œæ”¹ç”¨JSONç­‰å®‰å…¨æ ¼å¼ï¼ˆå¦‚Gsonï¼‰

- **ç™½åå•æ§åˆ¶**ï¼ˆJDKâ‰¥9ï¼‰ï¼š

  ```
  ObjectInputFilter filter = ObjectInputFilter.Config.createFilter(
      "com.trusted.pkg.*;!*"  // ä»…å…è®¸æŒ‡å®šåŒ…åçš„ç±»
  );
  ois.setObjectInputFilter(filter);
  ```

- **å­—æ®µéªŒè¯**ï¼šåœ¨`readObject()`ä¸­æ ¡éªŒå…³é”®å­—æ®µåˆæ³•æ€§

#### ğŸ“¦ **2. ä¾èµ–ä¸ç¯å¢ƒ**

- **å‡çº§åŸºç¡€åº“**ï¼š

  ```
  <!-- Commons Collectionså®‰å…¨ç‰ˆæœ¬ -->
  <dependency>
      <groupId>commons-collections</groupId>
      <artifactId>commons-collections</artifactId>
      <version>3.2.2+</version>
  </dependency>
  ```

- **JVMå‚æ•°åŠ å›º**ï¼š

  ```
  -Djdk.serialFilter=!org.apache.commons.collections.functors.*
  -Dcom.sun.jndi.rmi.object.trustURLCodebase=false
  ```

#### ğŸ” **3. æ£€æµ‹å·¥å…·**

- **æ¼æ´æ‰«æ**ï¼šä½¿ç”¨`ysoserial`ç”ŸæˆPayloadæµ‹è¯•ï¼ˆå‘½ä»¤ï¼š`java -jar ysoserial.jar CommonsCollections5 "id" > payload.bin`ï¼‰
- **åŠ¨æ€åˆ†æ**ï¼šç»“åˆ`SerializationDumper`è§£æåºåˆ—åŒ–æµç»“æ„

------

### **äº”ã€å­¦ä¹ èµ„æºæ¨è**

- **å·¥å…·å®è·µ**ï¼š
  - [ysoserial](https://github.com/frohoff/ysoserial)ï¼šç”Ÿæˆå„ç±»åˆ©ç”¨é“¾Payload
  - [JDD](https://github.com/fdu-sec/JDD)ï¼šè‡ªåŠ¨åŒ–åˆ©ç”¨é“¾æŒ–æ˜å·¥å…·ï¼ˆBlackHat Asia 2025ï¼‰
- **è°ƒè¯•æŠ€å·§**ï¼šåœ¨IDEAä¸­ä¸‹è½½`commons-collections 3.2.1`æºç ï¼Œæ–­ç‚¹è·Ÿè¸ª`LazyMap.get()`è°ƒç”¨æµç¨‹
- **é¶åœºç¯å¢ƒ**ï¼šVulhubï¼ˆ`WebLogic`/`JBoss`ååºåˆ—åŒ–æ¼æ´åœºæ™¯ï¼‰

> ğŸ’¡ **å°ç™½å­¦ä¹ è·¯çº¿**ï¼šå…ˆæŒæ¡URLDNSé“¾ï¼ˆç†è§£è§¦å‘é€»è¾‘ï¼‰ â†’ å†è°ƒè¯•CC1é“¾ï¼ˆå­¦ä¹ åå°„è°ƒç”¨ï¼‰ â†’ æœ€ååˆ†æCC6ï¼ˆäº†è§£ç»•è¿‡æŠ€å·§ï¼‰ï¼Œé…åˆé¶åœºå®æˆ˜å·©å›ºã€‚